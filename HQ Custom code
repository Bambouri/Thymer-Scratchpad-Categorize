class Plugin extends CollectionPlugin {

    onLoad() {
        const config = this.getConfiguration();
        this.apiKey = config.custom?.anthropic_api_key || "";

        // Get Area and Category options from config
        this.areaField = config.fields.find(f => f.label === "Area");
        this.categoryField = config.fields.find(f => f.label === "Category");

        this.ui.addCommandPaletteCommand({
            id: "generate-description",
            label: "Generate Description",
            icon: "ti-sparkles",
            onSelected: () => this.generateDescription()
        });

        this.ui.addCommandPaletteCommand({
            id: "categorize-note",
            label: "Categorize Note",
            icon: "ti-tags",
            onSelected: () => this.categorizeNote()
        });

        console.log("HQ plugin loaded!");
    }

    async getActiveRecord() {
        const panel = this.ui.getActivePanel();
        if (!panel) {
            this.ui.addToaster({
                title: "Error",
                message: "No active panel found",
                dismissible: true,
                autoDestroyTime: 3000
            });
            return null;
        }

        const record = panel.getActiveRecord();
        if (!record) {
            this.ui.addToaster({
                title: "Error",
                message: "No active doc found",
                dismissible: true,
                autoDestroyTime: 3000
            });
            return null;
        }

        return record;
    }

    async getNoteContent(record) {
        const lineItems = await record.getLineItems();
        let noteContent = "";
        
        for (const item of lineItems) {
            if (item.segments) {
                for (const seg of item.segments) {
                    if (seg.text) {
                        noteContent += seg.text + " ";
                    }
                }
            }
            noteContent += "\n";
        }
        
        return noteContent.trim();
    }

    async generateDescription() {
        const record = await this.getActiveRecord();
        if (!record) return;

        const noteContent = await this.getNoteContent(record);
        
        if (!noteContent) {
            this.ui.addToaster({
                title: "Error",
                message: "Doc is empty",
                dismissible: true,
                autoDestroyTime: 3000
            });
            return;
        }

        this.ui.addToaster({
            title: "Generating...",
            message: "Creating description",
            dismissible: true,
            autoDestroyTime: 2000
        });

        await this.callDescriptionLLM(record, noteContent);
    }

    async categorizeNote() {
        const record = await this.getActiveRecord();
        if (!record) return;

        const noteContent = await this.getNoteContent(record);
        const title = record.getName() || "";
        const needsTitle = !title || title === "Untitled Doc";
        
        if (!noteContent) {
            this.ui.addToaster({
                title: "Error",
                message: "Doc is empty",
                dismissible: true,
                autoDestroyTime: 3000
            });
            return;
        }

        this.ui.addToaster({
            title: "Processing...",
            message: "Categorizing and generating description",
            dismissible: true,
            autoDestroyTime: 2000
        });

        await this.callFullProcessLLM(record, title, noteContent, needsTitle);
    }

    async callDescriptionLLM(record, noteContent) {
        if (!this.apiKey) {
            this.ui.addToaster({
                title: "Error",
                message: "No API key configured",
                dismissible: true,
                autoDestroyTime: 3000
            });
            return;
        }

        try {
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": this.apiKey,
                    "anthropic-version": "2023-06-01",
                    "anthropic-dangerous-direct-browser-access": "true"
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-5-20250929",
                    max_tokens: 500,
                    messages: [{
                        role: "user",
                        content: `Write a 1-3 sentence summary that will help me understand this note weeks from now. Include the main point and any context if relevant. Keep it concise, no wordy sentences.

Here is the note:
"${noteContent}"

Respond with only the description, no other text.`
                    }]
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("API error:", errorText);
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();
            const description = data.content[0].text.trim();
            
            console.log("Generated description:", description);

            const descProp = record.prop("Description");
            if (descProp) {
                descProp.set(description);
                this.ui.addToaster({
                    title: "Done!",
                    message: "Description added",
                    dismissible: true,
                    autoDestroyTime: 2000
                });
            } else {
                this.ui.addToaster({
                    title: "Error",
                    message: "No 'Description' property found",
                    dismissible: true,
                    autoDestroyTime: 3000
                });
            }

        } catch (e) {
            console.error("LLM error:", e);
            this.ui.addToaster({
                title: "Error",
                message: "Failed to generate description: " + e.message,
                dismissible: true,
                autoDestroyTime: 3000
            });
        }
    }

    async callFullProcessLLM(record, title, noteContent, needsTitle) {
        if (!this.apiKey) {
            this.ui.addToaster({
                title: "Error",
                message: "No API key configured",
                dismissible: true,
                autoDestroyTime: 3000
            });
            return;
        }

        // Get current options from the config
        const areaOptions = this.areaField?.choices?.map(c => c.label) || ["Business", "Philosophy", "Life", "Other"];
        const categoryOptions = this.categoryField?.choices?.map(c => c.label) || ["Sales", "Marketing", "Product", "Operations", "Ideas", "Neuro Linguistic Programming", "Other"];

        const titleInstruction = needsTitle 
            ? `3. TITLE: Generate a title (max 7 words) that would help someone quickly understand what this note is about when scanning a list. Be descriptive and specific.`
            : `3. TITLE: Use exactly "${title}" (do not change it)`;

        try {
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": this.apiKey,
                    "anthropic-version": "2023-06-01",
                    "anthropic-dangerous-direct-browser-access": "true"
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-5-20250929",
                    max_tokens: 500,
                    messages: [{
                        role: "user",
                        content: `Process this note by doing the following:

1. AREA: Pick the single best area from: ${areaOptions.join(", ")}

2. CATEGORY: Pick the single best category, based on what the majority of the text is about, from: ${categoryOptions.join(", ")}

${titleInstruction}

4. DESCRIPTION: Write a 1-3 sentence summary that will help me understand this note weeks from now. Include the main point and any context if relevant. Keep it concise.

Here is the note content:
"${noteContent}"

Respond in this exact JSON format only, no other text:
{"area": "AreaName", "category": "CategoryName", "title": "TitleHere", "description": "DescriptionHere"}`
                    }]
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("API error:", errorText);
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();
            let content = data.content[0].text;
            
            // Strip markdown code blocks if present
            content = content.trim();
            if (content.startsWith("```json")) {
                content = content.slice(7);
            }
            if (content.startsWith("```")) {
                content = content.slice(3);
            }
            if (content.endsWith("```")) {
                content = content.slice(0, -3);
            }
            content = content.trim();
            
            const parsed = JSON.parse(content);
            console.log("Full process result:", parsed);

            // Set Title (only if it was Untitled Doc)
            if (needsTitle && parsed.title) {
                const titleProp = record.prop("title");
                if (titleProp) {
                    titleProp.set(parsed.title);
                    console.log("Title set to:", parsed.title);
                }
            }

            // Set Description
            if (parsed.description) {
                const descProp = record.prop("Description");
                if (descProp) {
                    descProp.set(parsed.description);
                    console.log("Description set to:", parsed.description);
                }
            }

            // Set Area
            if (parsed.area) {
                const areaProp = record.prop("Area");
                if (areaProp) {
                    const areaChoice = this.areaField?.choices?.find(c => c.label === parsed.area);
                    if (areaChoice) {
                        areaProp.set(areaChoice.id);
                        console.log("Area set to:", parsed.area);
                    }
                }
            }

            // Set Category
            if (parsed.category) {
                const categoryProp = record.prop("Category");
                if (categoryProp) {
                    const categoryChoice = this.categoryField?.choices?.find(c => c.label === parsed.category);
                    if (categoryChoice) {
                        categoryProp.set(categoryChoice.id);
                        console.log("Category set to:", parsed.category);
                    }
                }
            }

            this.ui.addToaster({
                title: "Done!",
                message: `${parsed.area} â†’ ${parsed.category}`,
                dismissible: true,
                autoDestroyTime: 2000
            });

        } catch (e) {
            console.error("LLM error:", e);
            this.ui.addToaster({
                title: "Error",
                message: "Failed to process: " + e.message,
                dismissible: true,
                autoDestroyTime: 3000
            });
        }
    }

}
